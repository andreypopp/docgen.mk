#!/usr/bin/env python
"""usage: dg-jinja2 [options] template

render jinja2 template

    -h, --help                    show this message and exit
    -b, --body BODY               read body from file or from stdin
                                  if equals to '-' then read from stdin
    -m, --metadata METADATA       metadata storage to use
    -p, --page PAGENAME           page name of currently rendered page

"""

from sys import stdin, stderr, exit
from docopt import docopt
from jinja2 import Environment, FileSystemLoader
from yaml import load

opts, args = docopt(__doc__)
if not args:
    print >> stderr, "provide template as argument"
    exit(1)

template = (Environment(loader=FileSystemLoader("."))
            .get_template(args[0]))

if opts.body and opts.body == "-":
    body = "".join(iter(stdin.read, "")).strip()
elif opts.body:
    body = open(opts.body).read()
else:
    body = ""

metadata = load(open(opts.metadata).read()) if opts.metadata else {}

print template.render(
    body=body.decode("utf8"), metadata=metadata, page=opts.page).encode("utf8")
