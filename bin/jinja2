#!/usr/bin/env python
"""usage: jinja2 [options] template

render jinja2 template

    -h, --help                    show this message and exit
    -b, --body BODY               read body from file or from stdin
                                  if equals to '-' then read from stdin
    -m, --metadata METADATA       metadata storage to use

"""

from sys import stdin, stderr
from docopt import docopt
from jinja2 import Environment, FileSystemLoader
from yaml import load

opts, args = docopt(__doc__)
if not args:
    exit("provide template as argument")

template = (Environment(loader=FileSystemLoader("."))
            .get_template(args[0]))

if opts.body and opts.body == "-":
    body = "".join(iter(stdin.read, "")).strip()
elif opts.body:
    body = open(opts.body).read()
else:
    body = ""

ctx = {}
ctx.update((load(open(opts.metadata).read()) or {}) if opts.metadata else {})
ctx.update({"body": body.decode("utf8")})
print template.render(**ctx).encode("utf8")
